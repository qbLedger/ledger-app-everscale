#include "contract.h"
#include "slice_data.h"
#include "byte_stream.h"
#include "cell.h"
#include "utils.h"
#include "errors.h"
#include "hashmap_label.h"

// Wallets code
const uint8_t safe_multisig_wallet[] = { 0x01, 0x02, 0x49, 0x01,
                                         0x00, 0x10, 0xF4, 0x00, 0x02, 0x01, 0x34, 0x06,
                                         0x01, 0x01, 0x01, 0xC0, 0x02, 0x02, 0x03, 0xCF,
                                         0x20, 0x05, 0x03, 0x01, 0x01, 0xDE, 0x04, 0x00,
                                         0x03, 0xD0, 0x20, 0x00, 0x41, 0xD8, 0x00, 0x00,
                                         0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                         0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                         0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                         0x00, 0x00, 0x00, 0x00, 0x00, 0x04 };

const uint8_t safe_multisig_wallet_24h[] = { 0x01, 0x02, 0x49, 0x01,
                                             0x00, 0x10, 0xF7, 0x00, 0x02, 0x01, 0x34, 0x06,
                                             0x01, 0x01, 0x01, 0xC0, 0x02, 0x02, 0x03, 0xCF,
                                             0x20, 0x05, 0x03, 0x01, 0x01, 0xDE, 0x04, 0x00,
                                             0x03, 0xD0, 0x20, 0x00, 0x41, 0xD8, 0x00, 0x00,
                                             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                             0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                             0x00, 0x00, 0x00, 0x00, 0x00, 0x04 };

const uint8_t setcode_multisig_wallet[] = { 0x01, 0x02, 0x65, 0x01,
                                            0x00, 0x1A, 0x04, 0x00, 0x02, 0x01, 0x34, 0x06,
                                            0x01, 0x01, 0x01, 0xC0, 0x02, 0x02, 0x03, 0xCF,
                                            0x20, 0x05, 0x03, 0x01, 0x01, 0xDE, 0x04, 0x00,
                                            0x03, 0xD0, 0x20, 0x00, 0x41, 0xD8, 0x00, 0x00,
                                            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                            0x00, 0x00, 0x00, 0x00, 0x00, 0x04 };

const uint8_t bridge_multisig_wallet[] = { 0x01, 0x02, 0x45, 0x01,
                                           0x00, 0x11, 0x04, 0x00, 0x02, 0x01, 0x34, 0x03,
                                           0x01, 0x01, 0x01, 0xC0, 0x02, 0x00, 0x43, 0xD0,
                                           0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                           0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                           0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                           0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                           0x20 };

const uint8_t multisig_2_wallet[] = { 0x01, 0x02, 0x56, 0x01,
                                      0x00, 0x0F, 0xDD, 0x00, 0x02, 0x01, 0x34, 0x03,
                                      0x01, 0x01, 0x01, 0xC0, 0x02, 0x00, 0x43, 0xD0,
                                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                      0x20 };

const uint8_t multisig_2_1_wallet[] = { 0x01, 0x02, 0x4D, 0x01,
                                        0x00, 0x10, 0xB2, 0x00, 0x02, 0x01, 0x34, 0x03,
                                        0x01, 0x01, 0x01, 0xC0, 0x02, 0x00, 0x43, 0xD0,
                                        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                        0x20 };

const uint8_t surf_wallet[] = { 0x01, 0x02, 0x4D, 0x01,
                                0x00, 0x12, 0xB4, 0x00, 0x02, 0x01, 0x34, 0x03,
                                0x01, 0x01, 0x01, 0xC0, 0x02, 0x00, 0x43, 0xD0,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x20 };
// Wallets code hash
const uint8_t wallet_v3_code_hash[] = { 0x84, 0xDA, 0xFA, 0x44, 0x9F, 0x98, 0xA6, 0x98,
                                        0x77, 0x89, 0xBA, 0x23, 0x23, 0x58, 0x07, 0x2B,
                                        0xC0, 0xF7, 0x6D, 0xC4, 0x52, 0x40, 0x02, 0xA5,
                                        0xD0, 0x91, 0x8B, 0x9A, 0x75, 0xD2, 0xD5, 0x99 };

const uint8_t ever_wallet_code_hash[] = { 0x3B, 0xA6, 0x52, 0x8A, 0xB2, 0x69, 0x4C, 0x11,
                                          0x81, 0x80, 0xAA, 0x3B, 0xD1, 0x0D, 0xD1, 0x9F,
                                          0xF4, 0x00, 0xB9, 0x09, 0xAB, 0x4D, 0xCF, 0x58,
                                          0xFC, 0x69, 0x92, 0x5B, 0x2C, 0x7B, 0x12, 0xA6 };

const uint8_t safe_multisig_wallet_code_hash[] = { 0x80, 0xd6, 0xc4, 0x7c, 0x4a, 0x25, 0x54, 0x3c,
                                                   0x9b, 0x39, 0x7b, 0x71, 0x71, 0x6f, 0x3f, 0xae,
                                                   0x1e, 0x2c, 0x5d, 0x24, 0x71, 0x74, 0xc5, 0x2e,
                                                   0x2c, 0x19, 0xbd, 0x89, 0x64, 0x42, 0xb1, 0x05 };

const uint8_t safe_multisig_wallet_24h_code_hash[] = { 0x7d, 0x09, 0x96, 0x94, 0x34, 0x06, 0xf7, 0xd6,
                                                       0x2a, 0x4f, 0xf2, 0x91, 0xb1, 0x22, 0x8b, 0xf0,
                                                       0x6e, 0xbd, 0x3e, 0x04, 0x8b, 0x58, 0x43, 0x6c,
                                                       0x5b, 0x70, 0xfb, 0x77, 0xff, 0x8b, 0x4b, 0xf2 };

const uint8_t setcode_multisig_wallet_code_hash[] = { 0xe2, 0xb6, 0x0b, 0x6b, 0x60, 0x2c, 0x10, 0xce,
                                                      0xd7, 0xea, 0x8e, 0xde, 0x4b, 0xdf, 0x96, 0x34,
                                                      0x2c, 0x97, 0x57, 0x0a, 0x37, 0x98, 0x06, 0x6f,
                                                      0x3f, 0xb5, 0x0a, 0x4b, 0x2b, 0x27, 0xa2, 0x08 };

const uint8_t bridge_multisig_wallet_code_hash[] = { 0xF3, 0xA0, 0x7A, 0xE8, 0x4F, 0xC3, 0x43, 0x25,
                                                     0x9D, 0x7F, 0xA4, 0x84, 0x7B, 0x86, 0x33, 0x5B,
                                                     0x3F, 0xDC, 0xFC, 0x8B, 0x31, 0xF1, 0xBA, 0x4B,
                                                     0x7A, 0x94, 0x99, 0xD5, 0x53, 0x0F, 0x0B, 0x18 };

const uint8_t multisig_2_wallet_code_hash[] = { 0x29, 0xb2, 0x47, 0x76, 0xb3, 0xdf, 0x6a, 0x05,
                                                0xc5, 0xa1, 0xb8, 0xd8, 0xfd, 0x75, 0xcb, 0x72,
                                                0xa1, 0xd3, 0x3c, 0x0a, 0x44, 0x38, 0x53, 0x32,
                                                0xa8, 0xbf, 0xc2, 0x72, 0x7f, 0xb6, 0x65, 0x90 };

const uint8_t multisig_2_1_wallet_code_hash[] = { 0xd6, 0x6d, 0x19, 0x87, 0x66, 0xab, 0xdb, 0xe1,
                                                  0x25, 0x3f, 0x34, 0x15, 0x82, 0x6c, 0x94, 0x6c,
                                                  0x37, 0x1f, 0x51, 0x12, 0x55, 0x24, 0x08, 0x62,
                                                  0x5a, 0xeb, 0x0b, 0x31, 0xe0, 0xef, 0x2d, 0xf3, };


const uint8_t surf_wallet_code_hash[] = { 0x20, 0x7d, 0xc5, 0x60, 0xc5, 0x95, 0x6d, 0xe1,
                                          0xa2, 0xc1, 0x47, 0x93, 0x56, 0xf8, 0xf3, 0xee,
                                          0x70, 0xa5, 0x97, 0x67, 0xdb, 0x2b, 0xf4, 0x78,
                                          0x8b, 0x1d, 0x61, 0xad, 0x42, 0xcd, 0xad, 0x82 };

// Cell depths
const uint32_t safe_multisig_wallet_cell_depth = 0x0C;
const uint32_t safe_multisig_wallet_24h_cell_depth = 0x0C;
const uint32_t setcode_multisig_wallet_cell_depth = 0x0D;
const uint32_t bridge_multisig_wallet_cell_depth = 0x0B;
const uint32_t multisig_2_wallet_cell_depth = 0x0C;
const uint32_t multisig_2_1_wallet_cell_depth = 0x0A;
const uint32_t surf_wallet_cell_depth = 0x0C;

void deserialize_cells_tree(struct ByteStream_t* src) {
    uint8_t first_byte = ByteStream_read_byte(src);
    {
        bool index_included = (first_byte & 0x80) != 0;
        bool has_crc = (first_byte & 0x40) != 0;
        bool has_cache_bits = (first_byte & 0x20) != 0;
        uint8_t flags = (first_byte & 0x18) >> 3;
        UNUSED(flags);
        VALIDATE(!index_included && !has_crc && !has_cache_bits, ERR_INVALID_DATA);
    }

    uint8_t ref_size = first_byte & 0x7; // size in bytes
    VALIDATE(ref_size == 1, ERR_INVALID_DATA);

    uint8_t offset_size = ByteStream_read_byte(src);
    VALIDATE(offset_size != 0 && offset_size <= 8, ERR_INVALID_DATA);

    uint8_t cells_count = ByteStream_read_uint(src, ref_size);
    uint8_t roots_count = ByteStream_read_uint(src, ref_size);
    VALIDATE(roots_count == MAX_ROOTS_COUNT, ERR_INVALID_DATA);
    boc_context.cells_count = cells_count;

    {
        uint8_t absent_count = ByteStream_read_uint(src, ref_size);
        UNUSED(absent_count);
        uint8_t* total_cells_size = ByteStream_read_data(src, offset_size);
        UNUSED(total_cells_size);
        uint8_t* buf = ByteStream_read_data(src, roots_count * ref_size);
        UNUSED(buf);
    }

    Cell_t cell;
    for (uint8_t i = 0; i < cells_count; ++i) {
        uint8_t* cell_begin = ByteStream_get_cursor(src);
        Cell_init(&cell, cell_begin);
        uint16_t offset = deserialize_cell(&cell, i, cells_count);
        boc_context.cells[i] = cell;
        ByteStream_read_data(src, offset);

        if (src->offset >= src->data_size) {
            break;
        }
    }
}

void find_public_key_cell() {
    BocContext_t* bc = &boc_context;
    VALIDATE(Cell_get_data(&bc->cells[0])[0] & 0x20, ERR_INVALID_DATA); // has data branch

    uint8_t refs_count = 0;
    uint8_t* refs = Cell_get_refs(&bc->cells[0], &refs_count);
    VALIDATE(refs_count > 0 && refs_count <= 2, ERR_INVALID_DATA);

    uint8_t data_root = refs[refs_count - 1];
    VALIDATE(data_root != 0 && data_root <= MAX_CONTRACT_CELLS_COUNT, ERR_INVALID_DATA);
    refs = Cell_get_refs(&bc->cells[data_root], &refs_count);
    VALIDATE(refs_count != 0 && refs_count <= MAX_REFERENCES_COUNT, ERR_INVALID_DATA);

    uint8_t key_buffer[8];
    SliceData_t key;
    memset(key_buffer, 0, sizeof(key_buffer));
    SliceData_init(&key, key_buffer, sizeof(key_buffer));

    uint16_t bit_len = SliceData_remaining_bits(&key);
    put_to_node(refs[0], bit_len, &key);
}

void get_address(const uint32_t account_number, uint8_t wallet_type, uint8_t* address) {
}
